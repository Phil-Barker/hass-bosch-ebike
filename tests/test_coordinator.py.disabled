"""Test coordinator handling of None values from API."""
# conftest.py handles Home Assistant mocking before imports
from unittest.mock import MagicMock, AsyncMock
import pytest

from custom_components.bosch_ebike.coordinator import (
    BoschEBikeDataUpdateCoordinator,
)


def test_combine_bike_data_with_none_connected_module():
    """Test that coordinator handles None connectedModule gracefully.

    This simulates the scenario where users have ConnectModule but not Flow+
    subscription, causing the API to return null for connectedModule.
    """
    coordinator = BoschEBikeDataUpdateCoordinator(
        hass=MagicMock(),
        api=MagicMock(),
        bike_id="test-bike-id",
        bike_name="Test Bike",
    )

    # Simulate API response with connectedModule: null (becomes None in Python)
    profile_data = {
        "data": {
            "attributes": {
                "batteries": [{
                    "batteryLevel": 75,
                    "remainingEnergy": 500,
                    "totalEnergy": 625,
                    "isCharging": False,
                    "isChargerConnected": False,
                    "numberOfFullChargeCycles": {"total": 42},
                }],
                "driveUnit": {
                    "totalDistanceTraveled": 12345,
                    "lock": {
                        "isLocked": False,
                        "isEnabled": True,
                    },
                },
                # This is the key issue: API returns null for users without Flow+
                "connectedModule": None,
                "remoteControl": None,
            }
        }
    }

    # This should not raise an AttributeError
    result = coordinator._combine_bike_data(profile_data, None)

    # Verify the structure is correct
    assert result is not None
    assert "battery" in result
    assert "bike" in result
    assert "components" in result

    # Verify alarm_enabled is None (not causing an error)
    assert result["bike"]["alarm_enabled"] is None

    # Verify connected_module components are all None
    assert result["components"]["connected_module"]["product_name"] is None
    assert result["components"]["connected_module"]["software_version"] is None
    assert result["components"]["connected_module"]["serial_number"] is None

    # Verify other data is still processed correctly
    assert result["battery"]["level_percent"] == 75
    assert result["bike"]["total_distance_m"] == 12345


def test_combine_bike_data_with_missing_fields():
    """Test handling of various missing/null fields."""
    coordinator = BoschEBikeDataUpdateCoordinator(
        hass=MagicMock(),
        api=MagicMock(),
        bike_id="test-bike-id",
        bike_name="Test Bike",
    )

    # Simulate minimal API response
    profile_data = {
        "data": {
            "attributes": {
                "batteries": [{
                    "batteryLevel": 50,
                }],
                "driveUnit": {},
                "connectedModule": None,
                "remoteControl": None,
            }
        }
    }

    # Should not raise any errors
    result = coordinator._combine_bike_data(profile_data, None)

    assert result is not None
    assert result["battery"]["level_percent"] == 50


def test_combine_bike_data_with_empty_batteries():
    """Test handling of empty batteries array."""
    coordinator = BoschEBikeDataUpdateCoordinator(
        hass=MagicMock(),
        api=MagicMock(),
        bike_id="test-bike-id",
        bike_name="Test Bike",
    )

    profile_data = {
        "data": {
            "attributes": {
                "batteries": [],
                "driveUnit": {},
                "connectedModule": None,
                "remoteControl": None,
            }
        }
    }

    # Should not raise IndexError
    result = coordinator._combine_bike_data(profile_data, None)

    assert result is not None


def test_combine_bike_data_with_none_lock():
    """Test handling of None lock field."""
    coordinator = BoschEBikeDataUpdateCoordinator(
        hass=MagicMock(),
        api=MagicMock(),
        bike_id="test-bike-id",
        bike_name="Test Bike",
    )

    profile_data = {
        "data": {
            "attributes": {
                "batteries": [{
                    "batteryLevel": 80,
                }],
                "driveUnit": {
                    "totalDistanceTraveled": 5000,
                    "lock": None,  # lock field is None
                },
                "connectedModule": None,
                "remoteControl": None,
            }
        }
    }

    # Should not raise AttributeError when accessing lock.get()
    result = coordinator._combine_bike_data(profile_data, None)

    assert result is not None
    assert result["bike"]["is_locked"] is None
    assert result["bike"]["lock_enabled"] is None


@pytest.mark.asyncio
async def test_async_update_data_with_none_connected_module():
    """Test the full async update flow with None connectedModule."""
    mock_api = MagicMock()
    mock_api.get_bike_profile = AsyncMock(return_value={
        "data": {
            "attributes": {
                "batteries": [{
                    "batteryLevel": 90,
                    "isCharging": True,
                }],
                "driveUnit": {},
                "connectedModule": None,
                "remoteControl": None,
            }
        }
    })

    coordinator = BoschEBikeDataUpdateCoordinator(
        hass=MagicMock(),
        api=mock_api,
        bike_id="test-bike-id",
        bike_name="Test Bike",
    )

    # Should not raise any errors
    result = await coordinator._async_update_data()

    assert result is not None
    assert "bike" in result
    assert result["bike"]["alarm_enabled"] is None
